{% extends "layout.html" %}
{% block content %}
<div class="container py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="text-primary fw-bold mb-0">ü¶∑ Treatment Summary</h4>
      <p class="small text-muted mb-0">Patient: {{ treatment.patient.full_name }}</p>

      {% if treatment.case %}
      <p class="small text-muted">
        Case:
        <a href="{{ url_for('view_case', case_id=treatment.case.id) }}" class="text-decoration-none">
          {{ treatment.case.case_id }}
        </a>
      </p>
      {% endif %}
    </div>

    <div>
      {% if session.get('role') in ['doctor','assistant'] %}
        <a href="{{ url_for('delete_treatment', treatment_id=treatment.id) }}"
           onclick="return confirm('Are you sure you want to delete this treatment?')"
           class="btn btn-sm btn-outline-danger me-2">üóë Delete</a>
      {% endif %}

      <a href="{{ back_url }}" class="btn btn-secondary btn-sm">‚¨Ö Back</a>

    </div>
  </div>

  <hr>

  <!-- Treatment Details -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-info text-white fw-bold">
      ü™• Treatment Details
    </div>

    <div class="card-body">
      <table class="table table-bordered mb-0">
        <tbody>

          <tr>
            <th>Date</th>
            <td>{{ treatment.date }}</td>
            <th>Dentist</th>
            <td>{{ treatment.dentist.name if treatment.dentist else treatment.doctor }}</td>
          </tr>

          <tr>
            <th>Treatment Type</th>
            <td colspan="3">{{ treatment.treatment_type }}</td>
          </tr>

          <tr>
            <th>Tooth / Site</th>
            <td colspan="3">{{ treatment.tooth_number or treatment.multi_tooth or '‚Äî' }}</td>
          </tr>

          {# --- Extraction specific rows --- #}
          {% if treatment.extraction_type %}
          <tr>
            <th>Extraction Type</th>
            <td colspan="3">{{ treatment.extraction_type }}</td>
          </tr>
          {% endif %}

          {% if treatment.la_type or treatment.la_volume %}
          <tr>
            <th>Local Anesthesia</th>
            <td colspan="3">
              {% if treatment.la_type %}{{ treatment.la_type }}{% endif %}
              {% if treatment.la_volume %}
                {% if treatment.la_type %} ‚Äî {% endif %}
                {{ treatment.la_volume }} ml
              {% endif %}
            </td>
          </tr>
          {% endif %}

          {% if treatment.impaction_type %}
          <tr>
            <th>Impaction</th>
            <td colspan="3">{{ treatment.impaction_type }}</td>
          </tr>
          {% endif %}

          {% if treatment.extraction_difficulty %}
          <tr>
            <th>Difficulty</th>
            <td colspan="3">{{ treatment.extraction_difficulty }}</td>
          </tr>
          {% endif %}

          {% if treatment.flap_type %}
          <tr>
            <th>Flap</th>
            <td colspan="3">{{ treatment.flap_type }}</td>
          </tr>
          {% endif %}

          {% if treatment.bone_removal %}
          <tr>
            <th>Bone Removal</th>
            <td colspan="3">Yes</td>
          </tr>
          {% endif %}

          {% if treatment.tooth_sectioning %}
          <tr>
            <th>Sectioning</th>
            <td colspan="3">
              Yes{% if treatment.sectioning_details %} ‚Äî {{ treatment.sectioning_details }}{% endif %}
            </td>
          </tr>
          {% endif %}

          {% if treatment.suture_type %}
          <tr>
            <th>Suture</th>
            <td colspan="3">{{ treatment.suture_type }}</td>
          </tr>
          {% endif %}

          <tr>
            <th>Fee (Rs.)</th>
            <td>{{ treatment.amount or 0 }}</td>
            <th>Next Appointment</th>
            <td>{{ treatment.next_appointment or '‚Äî' }}</td>
          </tr>

          <tr>
            <th>Notes</th>
            <td colspan="3" style="white-space: pre-wrap;">{{ treatment.notes or '‚Äî' }}</td>
          </tr>

        </tbody>
      </table>
    </div>
  </div>


  {# ======================== RCT WL/MAF SECTION ======================== #}
  {% set has_rct_data = (treatment.working_length or treatment.maf or treatment.obturation_material) %}
  {% if has_rct_data %}
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-secondary text-white fw-bold">üî¨ Root Canal Details</div>

    <div class="card-body">

      {% if treatment.obturation_material %}
      <p><strong>Obturation Material:</strong> {{ treatment.obturation_material }}</p>
      {% endif %}

      {# Parse WL & MAF strings like "MB1:20, MB2:21" or "MB1=20;MB2=21" #}
      {% set wl = {} %}
      {% set maf = {} %}

      {# --- Working Length map --- #}
      {% set wl_raw = (treatment.working_length or '')|replace(';', ',')|replace('|', ',') %}
      {% for pair in wl_raw.split(',') %}
        {% set pair = pair.strip() %}
        {% if ':' in pair or '=' in pair %}
          {% set pair = pair|replace('=', ':') %}
          {% set k = pair.split(':')[0].strip() %}
          {% set v = pair.split(':')[1].strip() %}
          {% if k %}
            {% set _ = wl.update({k: v}) %}
          {% endif %}
        {% endif %}
      {% endfor %}

      {# --- MAF map --- #}
      {% set maf_raw = (treatment.maf or '')|replace(';', ',')|replace('|', ',') %}
      {% for pair in maf_raw.split(',') %}
        {% set pair = pair.strip() %}
        {% if ':' in pair or '=' in pair %}
          {% set pair = pair|replace('=', ':') %}
          {% set k = pair.split(':')[0].strip() %}
          {% set v = pair.split(':')[1].strip() %}
          {% if k %}
            {% set _ = maf.update({k: v}) %}
          {% endif %}
        {% endif %}
      {% endfor %}

      {% if wl %}
      <table class="table table-striped table-bordered text-center mb-0">
        <thead class="table-light">
          <tr>
            <th>Canal</th>
            <th>Working Length (mm)</th>
            <th>MAF (#)</th>
          </tr>
        </thead>
        <tbody>
          {% for canal, wl_val in wl.items() %}
          <tr>
            <td>{{ canal }}</td>
            <td>{{ wl_val }}</td>
            <td>{{ maf.get(canal, '-') }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        {# Fallback if parsing fails but raw text exists #}
        {% if treatment.working_length or treatment.maf %}
        <p class="mb-1"><strong>Working Length (raw):</strong> {{ treatment.working_length }}</p>
        <p class="mb-0"><strong>MAF (raw):</strong> {{ treatment.maf }}</p>
        {% else %}
        <p class="text-muted mb-0">No canal-wise RCT measurements recorded.</p>
        {% endif %}
      {% endif %}

    </div>
  </div>
  {% endif %}


  {# ======================== POST-OP INSTRUCTIONS (DERIVED) ======================== #}
  {% if treatment.treatment_type and 'Extraction' in treatment.treatment_type %}
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-warning fw-bold text-dark">üìù Post-operative Instructions (Standard)</div>
    <div class="card-body small">
      <ol class="mb-0">
        <li>Bite on gauze for 30‚Äì45 minutes to establish hemostasis. Replace gauze if heavy bleeding persists.</li>
        <li>Avoid rinsing, spitting or hot drinks for the first 24 hours.</li>
        <li>Keep your head elevated and rest for the remainder of the day.</li>
        <li>Take a soft, cool diet for 24 hours and avoid chewing on the extraction side.</li>
        <li>Take prescribed painkillers and antibiotics (if given) strictly as directed.</li>
        {% if treatment.bone_removal %}
        <li>As bone removal was done, avoid strenuous activity for 3‚Äì5 days and follow suture care instructions carefully.</li>
        {% endif %}
        <li>If swelling, persistent bleeding, foul taste or fever develops, contact the clinic immediately.</li>
        <li>If sutures were placed, they should be reviewed / removed in about 5‚Äì7 days.</li>
      </ol>
    </div>
  </div>
  {% endif %}


  <!-- Attachments -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-dark text-white fw-bold">üìé Files Attached</div>

    <div class="card-body">
      {% if treatment.related_files %}
      <div class="row">
        {% for f in treatment.related_files %}
        <div class="col-md-3 mb-3 text-center">
          <div class="card shadow-sm">
            <div class="card-body">

              {% if f.filename.endswith('.pdf') %}
                <a href="{{ url_for('uploaded_file', filename=f.filename) }}" target="_blank">
                  <img src="{{ url_for('static', filename='pdf_icon.png') }}" class="img-thumbnail" style="height:120px;">
                </a>
              {% else %}
                <img src="{{ url_for('uploaded_file', filename=f.filename) }}" class="img-thumbnail" style="height:120px;">
              {% endif %}

              <p class="small text-muted mt-1">{{ f.uploaded_at }}</p>

              {% if session.get('role') in ['doctor','assistant'] %}
                <a href="{{ url_for('delete_file', file_id=f.id) }}"
                   class="btn btn-sm btn-outline-danger mt-1">üóë Delete</a>
              {% endif %}

            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      {% else %}
        <p class="text-muted mb-0">No files uploaded.</p>
      {% endif %}
    </div>
  </div>

</div>

<style>
  th { width: 25%; }
  .table th, .table td { vertical-align: middle !important; }
  .card img { object-fit: cover; }
  .card { border-radius: 12px; }
</style>

{% endblock %}
