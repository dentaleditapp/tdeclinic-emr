{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="text-primary fw-bold mb-0">
        ğŸ“‚ {{ case.title }}
        <small class="text-muted">({{ case.case_no }})</small>
      </h4>
      <p class="small text-muted mb-0">
        Patient:
        <a href="{{ url_for('view_patient', patient_id=case.patient.id) }}" class="text-decoration-none">
          {{ case.patient.full_name }}
        </a>
      </p>
      <p class="small text-muted">Started: {{ case.start_date or 'â€”' }}</p>
    </div>
    <div>
      {% if session.get('role') in ['doctor','assistant'] %}
        {% if case.status != 'Completed' %}
          <a href="{{ url_for('mark_complete', obj_type='case', obj_id=case.id) }}" class="btn btn-sm btn-success me-2">âœ… Mark Completed</a>
        {% endif %}
        <a href="{{ url_for('delete_case', case_id=case.id) }}" class="btn btn-sm btn-outline-danger me-2"
           onclick="return confirm('Are you sure you want to delete this case?')">ğŸ—‘ Delete</a>
      {% endif %}
      <a href="{{ url_for('view_patient', patient_id=case.patient_id) }}" class="btn btn-secondary btn-sm">â¬… Back to Patient</a>
    </div>
  </div>
  <hr>

  <!-- Case Information -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-info text-white fw-bold">ğŸ©º Case Information</div>
    <div class="card-body">
      <p><b>Chief Complaint:</b> {{ case.chief_complaint or 'â€”' }}</p>
      <p><b>Diagnosis:</b> {{ case.diagnosis or 'â€”' }}</p>

      <hr>
      <h6 class="text-primary fw-bold mb-2">ğŸ”„ Dynamic Medical Information (Case-Specific)</h6>
      <div class="row">
        <div class="col-md-6">
          <ul class="mb-0">
            <li><b>Pregnant:</b> {{ case.pregnant or 'â€”' }}</li>
            <li><b>Weeks of Pregnancy:</b> {{ case.pregnancy_weeks or 'â€”' }}</li>
            <li><b>Breastfeeding:</b> {{ case.breastfeeding or 'â€”' }}</li>
            <li><b>Currently Taking New Medications:</b> {{ case.new_medications or 'â€”' }}</li>
          </ul>
        </div>
        <div class="col-md-6">
          <ul class="mb-0">
            <li><b>Recent Illness:</b> {{ case.recent_illness or 'â€”' }}</li>
            <li><b>New Conditions Since Last Visit:</b> {{ case.new_conditions or 'â€”' }}</li>
            <li><b>Change in Allergy / Medication History:</b> {{ case.change_in_allergy_or_medication or 'â€”' }}</li>
          </ul>
        </div>
      </div>

      <hr>
      <p><b>Treatment Plan:</b><br>{{ case.treatment_plan or 'â€”' }}</p>

      <p><b>Status:</b>
        {% if case.status == 'Completed' %}
          <span class="badge bg-success">Completed</span>
        {% else %}
          <span class="badge bg-warning text-dark">Ongoing</span>
        {% endif %}
      </p>
    </div>
  </div>

  <!-- Treatments Table -->
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
      <span>ğŸ’Š Treatments Under This Case</span>
      {% if session.get('role') in ['doctor','assistant'] %}
      <a href="{{ url_for('add_treatment', patient_id=case.patient.id) }}?case_id={{ case.id }}"
         class="btn btn-light btn-sm fw-bold">â• Add Treatment</a>
      {% endif %}
    </div>
    <div class="card-body">
      {% if treatments %}
      <table class="table table-bordered table-sm align-middle">
        <thead class="table-light text-center">
          <tr>
            <th>Date</th>
            <th>Treatment Type</th>
            <th>Tooth / Site</th>
            <th>Dentist</th>
            <th>Status</th>
            <th>Next Appointment</th>
            <th>Fee (Rs)</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for t in treatments %}
          <tr>
            <td>{{ t.date }}</td>
            <td style="white-space: pre-wrap;">{{ t.treatment_type or 'â€”' }}</td>
            <td>{{ t.tooth_number or t.multi_tooth or 'â€”' }}</td>
            <td>{{ t.dentist.name if t.dentist else t.doctor }}</td>
            <td>
              {% if t.status == 'Completed' %}
                <span class="badge bg-success">Completed</span>
              {% elif t.next_appointment %}
                <span class="badge bg-info text-dark">Next: {{ t.next_appointment }}</span>
              {% else %}
                <span class="badge bg-warning text-dark">Ongoing</span>
              {% endif %}
            </td>
            <td>{{ t.next_appointment or 'â€”' }}</td>
            <td>{{ t.amount or 0 }}</td>
            <td class="text-center">
              <a href="{{ url_for('view_treatment', treatment_id=t.id) }}" class="btn btn-sm btn-outline-primary">ğŸ” View</a>
              {% if session.get('role') in ['doctor','assistant'] %}
                {% if t.status != 'Completed' %}
                <a href="{{ url_for('mark_complete', obj_type='treatment', obj_id=t.id) }}" class="btn btn-sm btn-outline-success">âœ…</a>
                {% endif %}
                <a href="{{ url_for('delete_treatment', treatment_id=t.id) }}" class="btn btn-sm btn-outline-danger">ğŸ—‘</a>
              {% endif %}
            </td>
          </tr>
          {% if t.prescriptions %}
          <tr class="table-secondary">
            <td colspan="8">
              <b>Prescription:</b>
              <ul class="mb-0">
                {% for p in t.prescriptions %}
                  <li>{{ p.dosage_form }} {{ p.drug_name }} {{ p.strength }} â€”
                    {{ p.frequency }} Ã— {{ p.duration }} ({{ p.quantity }} pcs)
                    {% if p.notes %}<small class="text-muted">â€“ {{ p.notes }}</small>{% endif %}
                  </li>
                {% endfor %}
              </ul>
            </td>
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-muted mb-0">No treatments recorded for this case yet.</p>
      {% endif %}
    </div>
  </div>

</div>

<style>
  .card { border-radius: 12px; }
  .table th { color: #0d6efd; }
  ul li { margin-bottom: 4px; }
</style>
{% endblock %}
